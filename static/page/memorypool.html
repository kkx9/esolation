<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Memory Pool</title>
    <link rel="stylesheet" href="/static/css/layui.css">
    <style>
        .top-panel {
            border: 1px solid #eceff9;
            border-radius: 5px;
            text-align: center;
        }
        .top-panel > .layui-card-body{
            height: 60px;
        }
        .top-panel-number{
            line-height:60px;
            font-size: 30px;
            border-right:1px solid #eceff9;
        }
        .top-panel-tips{
            line-height:30px;
            font-size: 12px
        }
    </style>
</head>
<body>

<div class="layuimini-container">
<div class="layuimini-main">
    <div class="layui-col-xs12 layui-col-md6" style="text-align: center;">
        <div id="imageChart" style="min-height:500px;padding: 30px"></div>

        <div style="padding: 30px">
            <button class="layui-btn" id="image">IMAGE</button>
        </div>
    </div>

    <div class="layui-col-xs12 layui-col-md6" style="text-align: center;">
        <div id="trafficChart" style="min-height:500px;padding: 30px"></div>

        <div style="padding: 30px">
            <button class="layui-btn" id="traffic">TRAFFIC</button>
        </div>
    </div>
</div>
</div>

<script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script>
layui.use(['jquery', 'echarts'], function(){
      var $ = layui.jquery,
          echarts = layui.echarts;

      // 读取JSON文件
      function loadJSON(file, callback) {
        var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
        xobj.open('GET', file, true);
        xobj.onreadystatechange = function () {
          if (xobj.readyState == 4 && xobj.status == "200") {
            callback(xobj.responseText);
          }
        };
        xobj.send(null);
      }

      // 绘制多条折线图
      function drawMultiLineChart(data, chartName) {
        var til = "";
        if (chartName === 'imageChart') {
            til = 'Image Process';
        } else {
            til = 'Traffic';
        }
        var jsonData = JSON.parse(data);
        var chart = echarts.init(document.getElementById(chartName));
        var option = {
          backgroundColor: {
            type: 'linear',
            x: 0, // 渐变起始点 x 坐标
            y: 0, // 渐变起始点 y 坐标
            x2: 1, // 渐变结束点 x 坐标
            y2: 1, // 渐变结束点 y 坐标
            colorStops: [{ // 渐变颜色的起始颜色
                offset: 0, color: '#FFFFFF' // 渐变起始颜色为红色
            }, {
                offset: 1, color: '#F0F0FF' // 渐变结束颜色为蓝色
            }],
            globalCoord: false // 是否使用全局坐标系
          },
          title: {
            text: til,
            left: 'center'
          },
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'cross'
            }
          },
          legend: {
            orient: 'vertical', // 设置图例水平显示
            x: 'right', // 设置图例水平居中
            y: 'top', // 设置图例在底部显示
            data:[]
          },
          xAxis: {
            type: 'category',
            name: 'Time-line(ms)',
            nameLocation: 'middle',
            data: jsonData.time,
            nameGap: 30
          },
          yAxis: {
            type: 'value',
            name: 'Memory footprint (GB)',
            nameLocation: 'middle',
            nameGap: 50,
            axisLine: {       // 不显示y轴线条
                show: false
            }
          },
          series: []
        };

        // 添加多条折线的系列数据
        for (var i = 0; i < jsonData.lines.length; i++) {
          option.series.push({
            name: jsonData.lines[i].name,
            type: 'line',
            data: jsonData.lines[i].data
          });
          option.legend.data.push(jsonData.lines[i].name)
        }

        chart.setOption(option);
      }


      // 定时更新统计图
      function updateChart() {
        loadJSON('/static/api/gpu/image.json', function(response) {
          drawMultiLineChart(response, 'imageChart');
        });
        loadJSON('/static/api/gpu/traffic.json', function(response) {
          drawMultiLineChart(response, 'trafficChart');
        });
      }

      // 初始化绘制统计图
      updateChart();

      // 每隔一段时间更新统计图
      setInterval(updateChart, 1000);

        // echarts 窗口缩放自适应
      window.onresize = function () {
          echartsRecords.resize();
      }
});
</script>

</body>
</html>
