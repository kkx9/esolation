<!--<!DOCTYPE html>-->
<!--<html>-->
<!--<head>-->
<!--    <meta charset="utf-8">-->
<!--    <title>CVE演示</title>-->
<!--    <meta name="renderer" content="webkit">-->
<!--    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">-->
<!--    <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">-->
<!--    <link rel="stylesheet" href="../css/public.css" media="all">-->
<!--</head>-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>演示系统</title>
    <link rel="stylesheet" href="/static/css/layui.css">
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <!-- 工具栏模板 -->
        <script type="text/html" id="toolbar">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm" lay-event="add">创建容器</button>
                <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="delete_many">删除</button>
            </div>
        </script>

        <!-- 表头某列 templet 属性指向的模板 -->
        <script type="text/html" id="tools">
            <a class="layui-btn layui-btn-sm layui-btn-xs" lay-event="root">ROOT</a>
            <a class="layui-btn layui-bg-blue layui-btn-xs" lay-event="exec">执行</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
        </script>
        <table class="layui-hide" id="container"></table>
    </div>
</div>

<!--<script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>-->
<script src="/static/layui.js"></script>
<script>
    layui.use(function () {
        var table = layui.table;

        function render_enable(d) {
            if (d.enable) {
                return '<span style="color: green">True</span>';
            } else {
                return '<span style="color: grey">False</span>';
            }
        }
        function render_command(d) {
            return '<input type="text" class="layui-input" style="height: 30px;" id="commandInput" value="' + (d.command || '') + '">';
        }
        function render_status(d) {
            if (d.status === null) {
                return '<span style="color: grey">None</span>'
            }
            if (d.status) {
                return '<span style="color: green">Success</span>';
            } else {
                return '<span style="color: red">False</span>';
            }
        }
        // 已知数据渲染
        var inst = table.render({
            elem: '#container',
            id: 'container',
            url: '/api/container',
            toolbar: '#toolbar',
            cols: [
                [   // 标题栏
                    {type: "checkbox", width: 50},
                    {field: 'id', title: 'ID', width: 60, sort: true},
                    {field: 'container_id', title: 'CONTAINER_ID', width: 150, sort: true},
                    {field: 'port', title: 'PORT', width: 100},
                    {field: 'enable', title: '启用', width: 100, templet: render_enable},
                    {field: 'create_at', title: '创建时间', width: 200},
                    {field: 'command', title: '命令', width: 200, templet: render_command},
                    {field: 'status', title: '状态', width: 100, templet: render_status},
                    {title: '操作', width: 180, templet: '#tools', align: "center"},
                    {field: 'results', title: '详情', minWidth: 170, align: "center"}
                ]],
            limits: [10, 15, 20, 25, 50, 100],
            limit: 15,
            page: true,
            skin: 'line'
        });
        // 头部工具栏事件
        table.on('toolbar(container)', function (obj) {
            var options = obj.config; // 获取当前表格属性配置项
            var checkStatus = table.checkStatus(options.id); // 获取选中行相关数据

            // 根据不同的事件名进行相应的操作
            switch (obj.event) { // 对应模板元素中的 lay-event 属性值
                case 'add':
                    window.show_add()
                    break;
                case 'delete_many':
                    window.delete_many(obj)
                    break;
            }
        });

        window.show_add = function () {
            layer.open({
                type: 2,
                title: '新增容器',
                shadeClose: true,
                maxmin: true, //开启最大化最小化按钮
                area: ['300px', '250px'],
                content: '../page/container_add.html'
            });
        }

        //监听表格复选框选择
        table.on('checkbox(container)', function (obj) {
            console.log(obj)
        });

        // 新增提交的方法
        const del_container_api = async (id) => {
            const options = {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
            }
            const response = await fetch(`/api/del/${id}`, options)
            return await response.json()
        }

        window.delete_many = function (obj) {
            var checkStatus = table.checkStatus('container')
                , data = checkStatus.data;
            for (i = 0; i < data.length; i++) {
                del_container_api(data[i].id).then(function (ret) {
                    // 提交成功之后的回调
                    if (!ret.code) {
                        layer.msg(ret.msg, {
                            icon: 1,
                            time: 1000,
                        }, function () {
                            table.reload('container');
                        });
                    } else {
                        layer.msg(ret.msg, {
                            icon: 2,
                            time: 1000,
                        });
                    }
                })
            }
        }

        var $ = layui.jquery;
        // 单元格工具事件
        table.on('tool(container)', function (obj) {
            var layEvent = obj.event; // 获得元素对应的 lay-event 属性值
            if (layEvent === 'root') {
                window.root(obj)
            } else if (layEvent === 'exec') { //执行
                window.exec(obj)
            } else if (layEvent === 'del') { //删除
                layer.confirm('确定删除吗？', function (index) {
                    layer.close(index);
                    window.del_container(obj)
                });
            }
        });

        // 新增提交的方法
        const root_api = async (id) => {
            const options = {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
            }
            const response = await fetch(`/api/root/${id}`, options)
            return await response.json()
        }

        window.root = (obj) => {
            root_api(obj.data.id).then(function (ret) {
                // 提交成功之后的回调
                if (!ret.code) {
                    layer.msg(ret.msg, {
                        icon: 1,
                        time: 1000,
                    }, function () {
                        table.reload('container');
                    });
                } else {
                    layer.msg(ret.msg, {
                        icon: 2,
                        time: 1000,
                    });
                }
            })
        }

        // 新增提交的方法
        const exec_api = async (id, commandValue) => {
            const options = {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id, command: commandValue })
            }
            const response = await fetch(`/api/exec/${id}`, options)
            return await response.json()
        }

        window.exec = (obj) => {
            var currentRow = $('.layui-table-body .layui-table-click');
            var commandValue = currentRow.find('.layui-input').val(); // 获取命令输入框的值
            if (commandValue === "") {
                layer.msg('命令不能为空！');
                return; // 不执行后续操作
            }
            exec_api(obj.data.id, commandValue).then(function (ret) {
                // 提交成功之后的回调
                if (!ret.code) {
                    layer.msg(ret.msg, {
                        icon: 1,
                        time: 1000,
                    }, function () {
                        table.reload('container');
                    });
                } else {
                    layer.msg(ret.msg, {
                        icon: 2,
                        time: 1000,
                    }, function () {
                        table.reload('container');
                    });
                }
            })
        }

        window.del_container = (obj) => {
            // console.log(obj)
            del_container_api(obj.data.id).then(function (ret) {
                // 提交成功之后的回调
                if (!ret.code) {
<!--                    obj.del();-->
                    layer.msg(ret.msg, {
                        icon: 1,
                        time: 1000,
                    }, function () {
                        table.reload('container');
                    });
                } else {
                    layer.msg(ret.msg, {
                        icon: 2,
                        time: 1000,
                    });
                }
            })
        }

    });
</script>
</body>
</html>